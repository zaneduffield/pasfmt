# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Removed

- `Default` trait impl for `PasFmtConfiguration`.
- `LGeneric` and `RGeneric` token type in favour of `ChevronKind`.
- `OperatorKind::Pointer` in favour of `OperatorKind::Caret`.
- Ability to override configuration on the CLI with escaped values eg (`-Ckey="\uFF"`).
- Use of `Default::default` in `PasFmtConfiguration::get_config_object` to initialise the
  configuration object defaults. Users can instead provide the defaults in the `Deserialize` impl.
- Logging of the (toml-serialised) configuration object in `PasFmtConfiguration::get_config_object`.
  Users can log the object however they want outside of this function.

### Changed

- Error message when `--mode=check` fails on stdin, now reads `'<stdin>' has incorrect formatting`.
- Style of the (debug-level) logging of the current configuration. Previously it was in TOML format,
  now it's a simpler struct-level debug formatting.

### Added

- `try_create` and `validate` functions to the type generated by the `pasfmt_config!` macro.
- `ChevronKind` for distinguishing greater-than and less-than operators.
- `EqKind` for distinguishing declaration and binary equal operators.
- `InKind` for distinguishing import, for loop, and binary `In` keywords.
- `CaretKind` for distinguishing pointer type, and variable dereference operators.
- `OperatorKind::Caret(CaretKind)` to represent `^` tokens.
- `DeclKind` for distinguishing kinds of `var` and `const` keywords.
- `LogicalLineType::CaseArm` to represent the arms of a case statement.
- `LogicalLineType::Declaration` to represent `label`, `type`, `const` etc. declarations.

### Fixed

- Lexing of conditional directive expressions containing compiler directives, comments, or strings.
- Lexing of compiler directives similar to conditional directives (e.g. `{$if_}`).
- Lexing of unterminated asm text literals at EOF.
- `--config-file` no longer erroneously accepts a path to a directory and searches from it for a
  `pasfmt.toml` file. It is now an error to provide a path to a directory.
- Detection of decoding errors when reading from stdin.
- Silent ignoral of non-existent paths (were being treated as globs matching no files).
- Parsing of repeated label definitions.
- Consolidation of `in` as identifier in `class operator In` construct.
- Duplicated line attribution of mid-line compiler directives.
- Parsing of `class helper`s with parent a type.
- Parsing of generics parameters in routine headers.
- Block comment kind for multiline comments on their own line.
- Parsing of anonymous routines with trailing semicolons.
- Errors on writing non-ASCII data in an ANSI encoding to a Windows Console. Now written as Unicode.
- Typo in `pasfmt_orchestrator::prelude` module name (was `predule`).

## [0.3.0] - 2024-05-29

### Removed

- `RefToken` and `OwningToken` types.

### Changed

- `Token` type to be a struct containing a `std::borrow::Cow` for the token content instead of
  an enum of `RefToken` and `OwningToken`.
- `--files-file` parameter to `--files-from`.

### Fixed

- Missing `winapi` keyword.
- Erroneous removal of BOM.
- Erroneous transcoding of UTF-16 input to UTF-8.
- Unwanted use of the replacement character when encoding. This now results in an error.

## [0.2.0] - 2024-05-07

### Added

- `string` as a keyword.
- Support for Delphi 12 multi-line string literals.
- `-C` CLI option to override configuration options.
- `--mode` CLI option which replaces the `--write` and `--verify` options.
  The default for this option is dynamic; when files to format are provided the default is `files`,
  otherwise (when formatting stdin) it's `stdout`. This differs from the previous default behaviour
  which was equivalent to `stdout`. <br/>
  `check` mode replaces `--verify` with some differences:
  - Non-zero exit code in the case of incorrectly formatted files.
  - Can be used in stdin/stdout mode.
  - Messages for incorrectly formatted files prefixed with 'CHECK' instead of 'VERIFY', and are
    sent to stderr, not stdout.
- `Formatter::format_into_buf` and `Reconstructor::reconstruct_into_buf` to allow reuse of memory
  allocations.
- Validation on the reconstruction settings. This now ensures that indentation, eol, and continuation
  are all non-empty and only consist of whitespace. Without this validation, the format may not be
  idempotent.
- Colour styling in CLI help.
- `RawTokenType` as a copy of `TokenType` with `IdentifierOrKeyword`.

### Removed

- `add`, `remove`, and `variant` as keywords.
- short version of `--config-file` CLI option.
- `--write`/`-w` CLI option (now accessible via `--mode=files`).
- `--verify` CLI option (replaced by `--mode=check` with some differences).
- `IdentifierOrKeyword` variant of `TokenType` enum.

### Changed

- `TokenType::TextLiteral` to contain a `TextLiteralKind`.
- Handling of unterminated comments and text literals.
- The default encoding on Windows to be the system ANSI codepage.
- The default encoding on non-Windows platforms to be UTF-8.
- Handling of IO errors. Previously any IO error would immediately crash the program.
  Now errors are logged when they occur and cause the program to exit non-zero after
  all other files have been formatted successfully.
- Default continuation to be the same as the configured indentation.
- The intermediate type of tokens between lexing and line parsing from `Token` to `RawToken`.
  This is to allow the logical line parser to consolidate the token types while processing.
  Additionally, formatters and consolidators operating after parsing do not need to worry about
  any identifier/keyword ambiguities.
- Logical line parsing:
  - Added more `LogicalLineType` variants.
    - `Assignment`
    - `CompilerDirective`
    - `ForLoop`
    - `RoutineHeader`
    - `InlineDeclaration`
    - `InlineStatement`
    - `Guid`
    - `CaseHeader`
  - Added support for more Delphi structures:
    - Tagged records.
    - `with` statements.
    - `forward` and `external` routine declarations.
  - Simplified handling for comments and compiler directives.
  - Consolidated all token types based on context.
  - Improved support for `property` and routine directives.

### Fixed

- Incorrect parsing for generic type param lists containing semicolons.
- Extra trailing newline when formatting stdin to stdout.
- Lexical edge cases:
  - Codepoints in `[U+00, U+20)` and `U+3000` are now lexed as whitespace instead of `Unknown`.
  - Non-ascii codepoints (excluding `U+3000`) are now lexed as identifiers instead of `Unknown`.
  - Hex and binary integer literals token types were reversed (unobservable with the current rules).
  - Binary literals now can contain underscore (e.g. `%_1`).
  - Asm labels now can contain `@` characters.
  - Asm integer literals are now supported (e.g. octal `076O`, hex `0FFH`/`$FF`, binary `010B`).
  - Keywords used in qualified names are now lexed as identifiers (e.g. `System.String`).
  - Integer literals can now be escaped with multiple ampersands (e.g. `&&0`).
- Incorrect encoding used for writing files with encodings inferred from a BOM.
- Incorrect encoding used in stdin/stdout mode; UTF-8 was always used, but now the configured
  encoding is respected.

## [0.1.0] - 2023-08-28

### Added

- `lang` module containing all common types.
- `traits` module outlining the API.
  - `Lexer`
  - `TokenConsolidator`
  - `LogicalLineParser`
  - `LogicalLineConsolidator`
  - `TokenIgnorer`
  - `TokenRemover`
  - `LogicalLineFormatter`
  - `LogicalLineFileFormatter`
  - `Reconstructor`
- Default implementations of the fundamental traits.
- Ability to recognise and format uses clauses.
  - Package and library imports are not yet parsed.
  - Program uses clauses are ignored.
- Formatter to remove repeated empty new lines.
- Formatter to normalise to a single new line at eof.
- Trailing whitespace removal. This is a built-in feature.
- Orchestrator to handle parallelising the reading, formatting, and writing of files.
- Configuration and command-line frameworks.
- Default command-line interface.
- Formatting toggle comments.
- Benchmarking tool.
- Token spacing rules.
